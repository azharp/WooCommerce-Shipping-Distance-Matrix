!function(h){"use strict";var e={_inputLatId:"",_inputLngId:"",_mapWrapperId:"",_mapSearchId:"",_mapCanvasId:"",_zoomLevel:16,_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",init:function(e){var n=this;n._params=e,n._inputLatSel="woocommerce_"+n._params.method_id+"_origin_lat",n._inputLngSel="woocommerce_"+n._params.method_id+"_origin_lng",n._mapWrapperSel=n._params.method_id+"-map-wrapper",n._mapSearchSel=n._params.method_id+"-map-search",n._mapCanvasSel=n._params.method_id+"-map-canvas",n._params.show_settings&&setTimeout(function(){for(var e=!1,t=h(document).find(".wc-shipping-zone-method-type"),o=0;o<t.length;o++){var a=t[o];if(h(a).text()==n._params.method_title)return h(a).closest("tr").find(".row-actions .wc-shipping-zone-method-settings").trigger("click"),void(e=!0)}e||(h(".wc-shipping-zone-add-method").trigger("click"),h("select[name='add_method_id']").val(n._params.method_id).trigger("change"))},200),h(document).on("click",".wc-shipping-zone-method-settings",function(){h(this).closest("tr").find(".wc-shipping-zone-method-type").text()===n._params.method_title&&(n._initGoogleMaps(),h("#woocommerce_wcsdm_gmaps_api_units").trigger("change"),h("#woocommerce_wcsdm_charge_per_distance_unit").trigger("change"))}),h(document).on("change","#"+n._inputLatSel+", #"+n._inputLngSel,function(){h(".gm-err-content").length||n._initGoogleMaps()}),h(document).on("change","#woocommerce_wcsdm_gmaps_api_units",function(){h("#rates-list-table").removeClass("metric imperial").addClass(h(this).val()),h("#per_distance_unit_selected").text(h(this).find("option:selected").text())}),h(document).on("change","#woocommerce_wcsdm_charge_per_distance_unit",function(){h(this).is(":checked")?h("#rates-list-table").addClass("charge-per-distance"):h("#rates-list-table").removeClass("charge-per-distance")}),h(document).on("click","#rates-list-table tbody .select-item",n._selectRateRows),h(document).on("click","#rates-list-table thead .select-item",n._toggleRateRows),h(document).on("click","#rates-list-table a.add",n._addRateRows),h(document).on("click","#rates-list-table a.remove_rows",n._removeRateRows)},_initGoogleMaps:function(e){var t=this;h("#"+t._mapWrapperSel).show().siblings(".description").hide();try{if("undefined"==typeof google||void 0===google.maps)throw"google is not defined";t._buildGoogleMaps()}catch(e){h.getScript("https://maps.googleapis.com/maps/api/js?key="+t._decode(h("#map-secret-key").val())+"&libraries=geometry,places&&language="+t._params.language,function(){t._buildGoogleMaps()})}},_buildGoogleMaps:function(){var o=this,e=-6.175392,t=106.827153,a=h("#"+o._inputLatSel).val(),n=h("#"+o._inputLngSel).val(),r={lat:a=a.length?parseFloat(a):e,lng:n=n.length?parseFloat(n):t},s=wp.template(o._mapCanvasSel),i=wp.template(o._mapSearchSel);h("#"+o._mapCanvasSel).length||h("#"+o._mapWrapperSel).append(s({map_canvas_id:o._mapCanvasSel}));var c=[],d=new google.maps.Map(document.getElementById(o._mapCanvasSel),{center:r,zoom:o._zoomLevel,mapTypeId:"roadmap"}),l=new google.maps.Marker({map:d,position:r,draggable:!0,icon:o._params.marker}),p=new google.maps.InfoWindow({maxWidth:350});a==e&&n==t?(p.setContent(o._params.txt.drag_marker),p.open(d,l)):o._setLatLng(l.position,l,d,p),google.maps.event.addListener(l,"dragstart",function(e){p.close()}),google.maps.event.addListener(l,"dragend",function(e){o._setLatLng(e.latLng,l,d,p)}),c.push(l),h("#"+o._mapSearchSel).length||h("#"+o._mapWrapperSel).append(i({map_search_id:o._mapSearchSel}));var m=document.getElementById(o._mapSearchSel),g=new google.maps.places.SearchBox(m);d.controls[google.maps.ControlPosition.TOP_LEFT].push(m),d.addListener("bounds_changed",function(){g.setBounds(d.getBounds())}),g.addListener("places_changed",function(){var e=g.getPlaces();if(0!==e.length){c.forEach(function(e){e.setMap(null)}),c=[];var t=new google.maps.LatLngBounds;e.forEach(function(e){e.geometry?(l=new google.maps.Marker({map:d,position:e.geometry.location,draggable:!0,icon:o._params.marker}),o._setLatLng(e.geometry.location,l,d,p),google.maps.event.addListener(l,"dragstart",function(e){p.close()}),google.maps.event.addListener(l,"dragend",function(e){o._setLatLng(e.latLng,l,d,p)}),c.push(l),e.geometry.viewport?t.union(e.geometry.viewport):t.extend(e.geometry.location)):console.log("Returned place contains no geometry")}),d.fitBounds(t)}}),setInterval(function(){h(".gm-err-content").length&&(h("#"+o._mapWrapperSel).hide().siblings(".description").show(),h("#"+o._mapSearchSel).remove(),google=void 0)},1e3)},_setLatLng:function(e,o,a,n){(new google.maps.Geocoder).geocode({latLng:e},function(e,t){t==google.maps.GeocoderStatus.OK&&e[0]&&(n.setContent(e[0].formatted_address),n.open(a,o),o.addListener("click",function(){n.open(a,o)}))}),a.setCenter(e),h("#"+this._inputLatSel).val(e.lat()),h("#"+this._inputLngSel).val(e.lng())},_selectRateRows:function(e){var t=h(e.currentTarget),o=t.closest("tbody").find("input[type=checkbox]"),a=t.closest("tbody").find("input[type=checkbox]:checked");a.length&&a.length===o.length?t.closest("table").find("thead input[type=checkbox]").prop("checked",!0):t.closest("table").find("thead input[type=checkbox]").prop("checked",!1),a.length?(t.closest("table").find(".button.remove_rows").show(),t.closest("table").find(".button.add").hide()):(t.closest("table").find(".button.remove_rows").hide(),t.closest("table").find(".button.add").show()),o.each(function(e,t){h(t).is(":checked")?h(t).closest("tr").addClass("selected"):h(t).closest("tr").removeClass("selected")})},_toggleRateRows:function(e){var t=h(e.currentTarget);t.is(":checked")?(t.closest("table").find("tr").addClass("selected").find("input[type=checkbox]").prop("checked",!0),t.closest("table").find("tbody input[type=checkbox]").length&&(t.closest("table").find(".button.remove_rows").show(),t.closest("table").find(".button.add").hide())):(t.closest("table").find("tr").removeClass("selected").find("input[type=checkbox]").prop("checked",!1),t.closest("table").find("tbody input[type=checkbox]").length&&(t.closest("table").find(".button.remove_rows").hide(),t.closest("table").find(".button.add").show()))},_addRateRows:function(e){e.preventDefault();var t=wp.template("rates-list-input-table-row"),o={field_key:h(e.currentTarget).data("key"),distance_unit:h("#woocommerce_wcsdm_gmaps_api_units").val(),charge_per_distance_unit:h("#woocommerce_wcsdm_charge_per_distance_unit").is(":checked")?h("#woocommerce_wcsdm_gmaps_api_units").val():""};h("#rates-list-table tbody").append(t(o))},_removeRateRows:function(e){e.preventDefault();var t=h(e.currentTarget);t.hide(),t.closest("table").find(".button.add").show(),t.closest("table").find("thead input[type=checkbox]").prop("checked",!1),t.closest("table").find("tbody input[type=checkbox]").each(function(e,t){h(t).is(":checked")&&h(t).closest("tr").remove()})},_encode:function(e){var t,o,a,n,r,s,i,c="",d=0;for(e=this._utf8_encode(e);d<e.length;)n=(t=e.charCodeAt(d++))>>2,r=(3&t)<<4|(o=e.charCodeAt(d++))>>4,s=(15&o)<<2|(a=e.charCodeAt(d++))>>6,i=63&a,isNaN(o)?s=i=64:isNaN(a)&&(i=64),c=c+this._keyStr.charAt(n)+this._keyStr.charAt(r)+this._keyStr.charAt(s)+this._keyStr.charAt(i);return c},_decode:function(e){var t,o,a,n,r,s,i="",c=0;for(e=e.replace(/[^A-Za-z0-9+/=]/g,"");c<e.length;)t=this._keyStr.indexOf(e.charAt(c++))<<2|(n=this._keyStr.indexOf(e.charAt(c++)))>>4,o=(15&n)<<4|(r=this._keyStr.indexOf(e.charAt(c++)))>>2,a=(3&r)<<6|(s=this._keyStr.indexOf(e.charAt(c++))),i+=String.fromCharCode(t),64!=r&&(i+=String.fromCharCode(o)),64!=s&&(i+=String.fromCharCode(a));return i=this._utf8_decode(i)},_utf8_encode:function(e){e=e.replace(/rn/g,"n");for(var t="",o=0;o<e.length;o++){var a=e.charCodeAt(o);a<128?t+=String.fromCharCode(a):(127<a&&a<2048?t+=String.fromCharCode(a>>6|192):(t+=String.fromCharCode(a>>12|224),t+=String.fromCharCode(a>>6&63|128)),t+=String.fromCharCode(63&a|128))}return t},_utf8_decode:function(e){for(var t="",o=0,a=0,n=0;o<e.length;)(a=e.charCodeAt(o))<128?(t+=String.fromCharCode(a),o++):191<a&&a<224?(n=e.charCodeAt(o+1),t+=String.fromCharCode((31&a)<<6|63&n),o+=2):(n=e.charCodeAt(o+1),c3=e.charCodeAt(o+2),t+=String.fromCharCode((15&a)<<12|(63&n)<<6|63&c3),o+=3);return t}};h(document).ready(function(){e.init(wcsdm_params)})}(jQuery);